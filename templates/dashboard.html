<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Radar Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        radar: {
                            bg: '#0f1419',
                            card: '#1a1f2e',
                            border: '#2f3336',
                            accent: '#00d4aa',
                            muted: '#8899a6',
                            blue: '#1d9bf0',
                            red: '#f4212e',
                            yellow: '#ffd700',
                            green: '#00d4aa',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0f1419; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1a1f2e; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #2f3336; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #3a3f44; }
        .signal-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .signal-dot.active { background-color: #00d4aa; }
        .signal-dot.inactive { background-color: #2f3336; border: 1px solid #3f4346; }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <!-- Top Bar -->
    <header class="bg-radar-card border-b border-radar-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold">
                        <span class="text-radar-accent">STOCK</span> RADAR
                    </h1>
                    <span id="system-status" class="text-xs px-2 py-1 rounded bg-radar-border text-radar-muted">
                        Loading...
                    </span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <div id="last-update" class="text-radar-muted">
                        <span class="hidden sm:inline">Last update: </span>
                        <span id="last-update-time">--:--</span>
                    </div>
                    <div id="next-update" class="text-radar-muted">
                        <span class="hidden sm:inline">Next update: </span>
                        <span id="next-update-time">8:30 AM</span>
                    </div>
                    <div id="market-status" class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-radar-muted"></span>
                        <span class="text-radar-muted">Market: --</span>
                    </div>
                    <button onclick="refreshAll()" class="px-3 py-1 bg-radar-accent text-radar-bg rounded text-sm font-medium hover:opacity-90 transition">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Section 1: Stock of the Day (Hero) -->
        <section id="stock-of-day-section" class="bg-radar-card rounded-xl border border-radar-border overflow-hidden">
            <div id="stock-of-day-container">
                <div class="text-radar-muted text-center py-12">Loading...</div>
            </div>
        </section>

        <!-- Section 2: Open Positions -->
        <section id="positions-section" class="bg-radar-card rounded-xl border border-radar-border p-5">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    Open Positions
                </h2>
                <div id="portfolio-summary" class="flex items-center gap-4 text-sm">
                    <span class="text-radar-muted">Portfolio: <span id="portfolio-value" class="text-white font-medium">$--</span></span>
                    <span class="text-radar-muted">P&L: <span id="portfolio-pnl" class="font-medium">--</span></span>
                </div>
            </div>
            <div id="positions-container" class="overflow-x-auto scrollbar-thin">
                <div class="text-radar-muted text-center py-8">Loading positions...</div>
            </div>
        </section>

        <!-- Section 3: Watchlist / Other Candidates -->
        <section id="watchlist-section" class="bg-radar-card rounded-xl border border-radar-border p-5">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    Watchlist
                </h2>
                <div class="text-xs text-radar-muted">
                    Score <span id="threshold-display" class="text-white">25+</span> = Stock of the Day
                </div>
            </div>
            <div id="watchlist-container" class="space-y-2">
                <div class="text-radar-muted text-center py-8">Loading...</div>
            </div>
        </section>

        <!-- Section 4: Recent Activity -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Recent Activity
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Recent Insider Buys Detected</h3>
                    <div id="recent-insider-container" class="space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
                        <div class="text-radar-muted text-center py-4">Loading...</div>
                    </div>
                </div>
                <div id="recent-trades-section">
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Recent Closed Trades</h3>
                    <div id="recent-trades-container" class="space-y-2 max-h-48 overflow-y-auto scrollbar-thin">
                        <div class="text-radar-muted text-center py-4">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 5: Performance Summary (hidden until data exists) -->
        <section id="performance-section" class="bg-radar-card rounded-xl border border-radar-border p-5 hidden">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Performance Summary
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Total Trades</div>
                    <div id="stat-total-trades" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Win Rate</div>
                    <div id="stat-win-rate" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Avg Win</div>
                    <div id="stat-avg-win" class="text-2xl font-bold text-radar-green">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Avg Loss</div>
                    <div id="stat-avg-loss" class="text-2xl font-bold text-radar-red">--</div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Equity Curve vs SPY</h3>
                    <div class="bg-radar-bg rounded-lg p-4 border border-radar-border" style="height: 250px;">
                        <canvas id="equity-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Performance by Signal Score</h3>
                    <div id="score-breakdown" class="space-y-3">
                        <div class="text-radar-muted text-center py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 6: Quick Actions (at bottom) -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                Quick Actions
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Enter Trade Form (hidden by default, shown when clicking Enter Trade) -->
                <div id="enter-trade-section" class="bg-radar-bg rounded-lg p-4 border border-radar-border hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium">Enter New Trade</h3>
                        <button onclick="hideEnterForm()" class="text-radar-muted hover:text-white text-sm">Cancel</button>
                    </div>
                    <form id="enter-trade-form" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Ticker</label>
                                <input type="text" id="enter-ticker" placeholder=""
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent uppercase">
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Price (leave empty for current)</label>
                                <input type="number" id="enter-price" step="0.01" placeholder="Current"
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Position Size</label>
                                <select id="enter-size" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                    <option value="FULL">Full Position</option>
                                    <option value="HALF">Half Position</option>
                                    <option value="QUARTER" selected>Quarter Position</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Signal ID (optional)</label>
                                <input type="number" id="enter-signal-id" placeholder="Auto"
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 bg-radar-green text-radar-bg rounded font-medium text-sm hover:opacity-90 transition">
                            Confirm Trade Entry
                        </button>
                    </form>
                    <div id="enter-trade-status" class="mt-2 text-sm hidden"></div>
                </div>

                <!-- Exit Trade Form -->
                <div id="exit-trade-section" class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <h3 class="text-sm font-medium mb-3">Exit Trade</h3>
                    <form id="exit-trade-form" class="space-y-3">
                        <div>
                            <label class="text-xs text-radar-muted">Select Position</label>
                            <select id="exit-position" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                <option value="">-- Select open position --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Exit Price</label>
                                <input type="number" id="exit-price" step="0.01" placeholder="Current"
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Reason</label>
                                <select id="exit-reason" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                    <option value="TARGET">Target Hit</option>
                                    <option value="STOP">Stop Hit</option>
                                    <option value="TIME">Time Exit</option>
                                    <option value="MANUAL">Manual</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 bg-radar-red text-white rounded font-medium text-sm hover:opacity-90 transition">
                            Exit Trade
                        </button>
                    </form>
                    <div id="exit-trade-status" class="mt-2 text-sm hidden"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="border-t border-radar-border mt-8 py-4">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-radar-muted">
            Stock Radar Dashboard | Paper Trading Only | Not Financial Advice
        </div>
    </footer>

    <script>
        // Formatters
        const fmt = {
            pct: (v, decimals = 2) => v != null ? (v >= 0 ? '+' : '') + v.toFixed(decimals) + '%' : '--',
            money: (v) => v != null ? '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--',
            moneyInt: (v) => v != null ? '$' + Number(v).toLocaleString(undefined, {maximumFractionDigits: 0}) : '--',
            num: (v) => v != null ? Number(v).toLocaleString() : '--',
            date: (v) => v ? new Date(v).toLocaleDateString() : '--',
            time: (v) => v ? new Date(v).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'
        };

        const colorClass = (v) => v > 0 ? 'text-radar-green' : v < 0 ? 'text-radar-red' : 'text-radar-muted';

        let equityChart = null;
        let positionsData = [];
        let currentStockOfDay = null;

        // Show enter trade form with pre-filled data
        function showEnterForm(ticker, signalId, price) {
            document.getElementById('enter-trade-section').classList.remove('hidden');
            document.getElementById('enter-ticker').value = ticker || '';
            document.getElementById('enter-signal-id').value = signalId || '';
            document.getElementById('enter-price').value = price || '';
            document.getElementById('enter-trade-status').classList.add('hidden');
        }

        function hideEnterForm() {
            document.getElementById('enter-trade-section').classList.add('hidden');
            document.getElementById('enter-trade-form').reset();
        }

        // Load health status
        async function loadHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();

                document.getElementById('last-update-time').textContent = fmt.time(data.last_collection || new Date());

                const statusEl = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusEl.textContent = 'System OK';
                    statusEl.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-radar-green';
                } else {
                    statusEl.textContent = data.status || 'Unknown';
                    statusEl.className = 'text-xs px-2 py-1 rounded bg-yellow-900/50 text-radar-yellow';
                }

                const marketEl = document.getElementById('market-status');
                const dotClass = data.market_open ? 'bg-radar-green' : 'bg-radar-muted';
                const statusText = data.market_open ? 'Open' : 'Closed';
                marketEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full ${dotClass}"></span>
                    <span class="${data.market_open ? 'text-radar-green' : 'text-radar-muted'}">Market: ${statusText}</span>
                `;
            } catch (e) {
                console.error('Error loading health:', e);
            }
        }

        // Load Stock of the Day
        async function loadStockOfDay() {
            try {
                const res = await fetch('/api/stock-of-the-day');
                const data = await res.json();
                const container = document.getElementById('stock-of-day-container');

                // Update threshold display
                document.getElementById('threshold-display').textContent = data.threshold + '+';

                if (data.has_pick && data.stock_of_the_day) {
                    const s = data.stock_of_the_day;
                    currentStockOfDay = s;

                    const confidenceColor = s.confidence === 'HIGH' ? 'bg-radar-green' : 'bg-radar-yellow';
                    const confidenceText = s.confidence === 'HIGH' ? 'High Confidence' : 'Medium Confidence';

                    container.innerHTML = `
                        <div class="border-l-4 border-radar-green">
                            <div class="p-6">
                                <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
                                    <div>
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="text-4xl font-bold text-radar-blue">${s.ticker}</span>
                                            <span class="px-2 py-1 ${confidenceColor} text-radar-bg text-xs font-bold rounded">${confidenceText}</span>
                                        </div>
                                        <div class="text-radar-muted text-sm">${s.explanation || 'Signal alignment detected'}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-radar-muted text-xs mb-1">Score</div>
                                        <div class="text-2xl font-bold">${s.total_score}</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="bg-radar-bg rounded-lg p-4 border border-radar-border text-center">
                                        <div class="text-radar-muted text-xs mb-1">Entry Price</div>
                                        <div class="text-xl font-bold">${fmt.money(s.entry_price)}</div>
                                    </div>
                                    <div class="bg-radar-bg rounded-lg p-4 border border-radar-border text-center">
                                        <div class="text-radar-muted text-xs mb-1">Stop Loss (-10%)</div>
                                        <div class="text-xl font-bold text-radar-red">${fmt.money(s.stop_price)}</div>
                                    </div>
                                    <div class="bg-radar-bg rounded-lg p-4 border border-radar-border text-center">
                                        <div class="text-radar-muted text-xs mb-1">Target (+20%)</div>
                                        <div class="text-xl font-bold text-radar-green">${fmt.money(s.target_price)}</div>
                                    </div>
                                </div>

                                <div class="flex items-center gap-4">
                                    <button onclick="showEnterForm('${s.ticker}', ${s.id}, ${s.entry_price})"
                                        class="flex-1 py-3 bg-radar-green text-radar-bg rounded-lg font-bold text-lg hover:opacity-90 transition">
                                        Enter Trade
                                    </button>
                                    <div class="flex items-center gap-2 text-sm text-radar-muted">
                                        <span title="Insider" class="signal-dot ${s.insider_score >= 5 ? 'active' : 'inactive'}"></span>
                                        <span title="Options" class="signal-dot ${s.options_score >= 5 ? 'active' : 'inactive'}"></span>
                                        <span title="Social" class="signal-dot ${s.social_score >= 5 ? 'active' : 'inactive'}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // No pick today
                    currentStockOfDay = null;
                    let candidateHtml = '';

                    if (data.best_candidate) {
                        const c = data.best_candidate;
                        const missingText = c.missing && c.missing.length > 0
                            ? c.missing.join(', ')
                            : 'below threshold';

                        candidateHtml = `
                            <div class="mt-4 p-4 bg-radar-bg rounded-lg border border-radar-border">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="text-radar-blue font-bold">${c.ticker}</span>
                                        <span class="text-radar-muted text-sm ml-2">(score ${c.total_score})</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span title="Insider" class="signal-dot ${(c.insider_score || 0) >= 5 ? 'active' : 'inactive'}"></span>
                                        <span title="Options" class="signal-dot ${(c.options_score || 0) >= 5 ? 'active' : 'inactive'}"></span>
                                        <span title="Social" class="signal-dot ${(c.social_score || 0) >= 5 ? 'active' : 'inactive'}"></span>
                                    </div>
                                </div>
                                <div class="text-radar-muted text-sm mt-1">${missingText}</div>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="border-l-4 border-radar-muted">
                            <div class="p-6 text-center">
                                <div class="text-2xl font-bold text-radar-muted mb-2">No high-confidence picks today</div>
                                <div class="text-radar-muted text-sm">Wait for a better setup</div>
                                ${candidateHtml}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error loading stock of the day:', e);
                document.getElementById('stock-of-day-container').innerHTML = '<div class="text-radar-red text-center py-8">Error loading data</div>';
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                const res = await fetch('/api/watchlist');
                const data = await res.json();
                const container = document.getElementById('watchlist-container');

                // Filter out the Stock of the Day if it exists
                let signals = data.signals || [];
                if (currentStockOfDay) {
                    signals = signals.filter(s => s.id !== currentStockOfDay.id);
                }

                if (signals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6">
                            <div class="text-radar-muted">No other candidates today</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = signals.map(s => `
                    <div class="flex items-center justify-between p-3 bg-radar-bg rounded-lg border border-radar-border/50 hover:border-radar-border transition">
                        <div class="flex items-center gap-4">
                            <span class="text-radar-blue font-bold text-lg w-16">${s.ticker}</span>
                            <div class="flex items-center gap-1" title="Insider / Options / Social">
                                <span class="signal-dot ${s.has_insider ? 'active' : 'inactive'}"></span>
                                <span class="signal-dot ${s.has_options ? 'active' : 'inactive'}"></span>
                                <span class="signal-dot ${s.has_social ? 'active' : 'inactive'}"></span>
                            </div>
                            <span class="text-radar-muted text-sm">Score: <span class="text-white font-medium">${s.total_score}</span></span>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="text-radar-muted hidden sm:inline">Entry: ${fmt.money(s.entry_price)}</span>
                            <span class="text-radar-muted hidden sm:inline">Target: <span class="text-radar-green">${fmt.money(s.target_price)}</span></span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading watchlist:', e);
                document.getElementById('watchlist-container').innerHTML = '<div class="text-radar-red text-center py-4">Error loading watchlist</div>';
            }
        }

        // Load open positions
        async function loadPositions() {
            try {
                const res = await fetch('/api/positions');
                const data = await res.json();
                const container = document.getElementById('positions-container');
                const section = document.getElementById('positions-section');

                positionsData = data.positions || [];

                // Update portfolio summary
                document.getElementById('portfolio-value').textContent = fmt.moneyInt(data.portfolio_value);
                const pnlEl = document.getElementById('portfolio-pnl');
                pnlEl.textContent = fmt.money(data.total_unrealized_pnl) + ` (${fmt.pct(data.total_unrealized_pnl_pct)})`;
                pnlEl.className = `font-medium ${colorClass(data.total_unrealized_pnl)}`;

                // Update exit position dropdown
                const exitSelect = document.getElementById('exit-position');
                exitSelect.innerHTML = '<option value="">-- Select open position --</option>' +
                    positionsData.map(p => `<option value="${p.id}">${p.ticker} - ${p.shares} shares @ ${fmt.money(p.entry_price)}</option>`).join('');

                if (positionsData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-6">
                            <div class="text-radar-muted">No open positions</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-radar-muted text-xs border-b border-radar-border">
                                <th class="text-left py-2 px-2">Ticker</th>
                                <th class="text-right py-2 px-2">Entry</th>
                                <th class="text-right py-2 px-2">Current</th>
                                <th class="text-right py-2 px-2">P&L</th>
                                <th class="text-right py-2 px-2">Days</th>
                                <th class="text-left py-2 px-2 hidden sm:table-cell">To Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${positionsData.map(p => {
                                const pnlPct = p.unrealized_pnl_pct || 0;
                                const targetProgress = p.target_progress || 0;
                                const progressColor = pnlPct >= 0 ? 'bg-radar-green' : 'bg-radar-red';
                                return `
                                    <tr class="border-b border-radar-border/50 hover:bg-radar-border/20">
                                        <td class="py-3 px-2">
                                            <span class="text-radar-blue font-bold">${p.ticker}</span>
                                            <span class="text-radar-muted text-xs ml-1">${p.shares} sh</span>
                                        </td>
                                        <td class="text-right py-3 px-2">${fmt.money(p.entry_price)}</td>
                                        <td class="text-right py-3 px-2 font-medium">${fmt.money(p.current_price)}</td>
                                        <td class="text-right py-3 px-2">
                                            <span class="${colorClass(p.unrealized_pnl)}">${fmt.money(p.unrealized_pnl)}</span>
                                            <span class="${colorClass(pnlPct)} text-xs ml-1">${fmt.pct(pnlPct)}</span>
                                        </td>
                                        <td class="text-right py-3 px-2 text-radar-muted">${p.days_held}</td>
                                        <td class="py-3 px-2 hidden sm:table-cell">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 h-2 bg-radar-border rounded overflow-hidden">
                                                    <div class="h-full ${progressColor}" style="width: ${Math.min(100, Math.max(0, targetProgress))}%"></div>
                                                </div>
                                                <span class="text-xs text-radar-muted w-10">${targetProgress.toFixed(0)}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                console.error('Error loading positions:', e);
                document.getElementById('positions-container').innerHTML = '<div class="text-radar-red text-center py-4">Error loading positions</div>';
            }
        }

        // Load performance summary (only show if there's data)
        async function loadPerformance() {
            try {
                const res = await fetch('/api/performance');
                const data = await res.json();
                const section = document.getElementById('performance-section');

                // Only show if we have at least 5 closed trades
                if (!data.total_trades || data.total_trades < 5) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');

                document.getElementById('stat-total-trades').textContent = data.total_trades || 0;
                document.getElementById('stat-win-rate').textContent = data.win_rate != null ? data.win_rate.toFixed(1) + '%' : '--';
                document.getElementById('stat-avg-win').textContent = data.avg_win != null ? fmt.pct(data.avg_win) : '--';
                document.getElementById('stat-avg-loss').textContent = data.avg_loss != null ? fmt.pct(data.avg_loss) : '--';

                // Score breakdown
                const scoreContainer = document.getElementById('score-breakdown');
                if (data.by_score_tier && data.by_score_tier.length > 0) {
                    scoreContainer.innerHTML = data.by_score_tier.map(tier => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-radar-muted">Score ${tier.tier}</span>
                            <div class="flex items-center gap-4">
                                <span class="text-xs text-radar-muted">${tier.count} trades</span>
                                <span class="${colorClass(tier.avg_return)}">${fmt.pct(tier.avg_return)}</span>
                                <span class="text-xs text-radar-muted">${tier.win_rate?.toFixed(0) || '--'}% win</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    scoreContainer.innerHTML = '<div class="text-radar-muted text-center py-4 text-sm">No data yet</div>';
                }

                // Equity chart
                renderEquityChart(data.equity_curve || [], data.spy_curve || []);
            } catch (e) {
                console.error('Error loading performance:', e);
            }
        }

        // Render equity chart
        function renderEquityChart(equityCurve, spyCurve) {
            const ctx = document.getElementById('equity-chart').getContext('2d');

            if (equityChart) {
                equityChart.destroy();
            }

            const labels = equityCurve.map(p => p.date);
            const equityData = equityCurve.map(p => p.value);
            const spyData = spyCurve.map(p => p.value);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Portfolio',
                            data: equityData,
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                        },
                        {
                            label: 'SPY',
                            data: spyData,
                            borderColor: '#8899a6',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#8899a6', boxWidth: 12 }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2f3336' },
                            ticks: { color: '#8899a6', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2f3336' },
                            ticks: {
                                color: '#8899a6',
                                callback: (v) => v.toFixed(0) + '%'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load recent trades (only show section if there's data)
        async function loadRecentTrades() {
            try {
                const res = await fetch('/api/trades/recent');
                const data = await res.json();
                const container = document.getElementById('recent-trades-container');
                const section = document.getElementById('recent-trades-section');

                if (!data.trades || data.trades.length === 0) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');
                container.innerHTML = data.trades.map(t => `
                    <div class="flex items-center justify-between p-2 bg-radar-bg rounded border border-radar-border/50">
                        <div>
                            <span class="text-radar-blue font-medium">${t.ticker}</span>
                            <span class="text-radar-muted text-xs ml-2">${t.days_held}d</span>
                        </div>
                        <div class="text-right">
                            <span class="${colorClass(t.return_pct)} font-medium">${fmt.pct(t.return_pct)}</span>
                            <span class="text-radar-muted text-xs ml-2">${t.exit_reason || ''}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading recent trades:', e);
            }
        }

        // Load recent insider activity
        async function loadRecentInsider() {
            try {
                const res = await fetch('/api/insider/recent');
                const data = await res.json();
                const container = document.getElementById('recent-insider-container');

                if (!data.insider_buys || data.insider_buys.length === 0) {
                    container.innerHTML = '<div class="text-radar-muted text-center py-4 text-sm">No recent insider buys</div>';
                    return;
                }

                container.innerHTML = data.insider_buys.map(i => `
                    <div class="flex items-center justify-between p-2 bg-radar-bg rounded border border-radar-border/50">
                        <div>
                            <span class="text-radar-blue font-medium">${i.ticker}</span>
                            <span class="text-radar-muted text-xs ml-2">${i.insider_name || 'Insider'}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-radar-green font-medium">${fmt.moneyInt(i.total_value)}</span>
                            <span class="text-radar-muted text-xs ml-2">${fmt.date(i.trade_date)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading recent insider:', e);
            }
        }

        // Enter trade form
        document.getElementById('enter-trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('enter-trade-status');
            statusEl.className = 'mt-2 text-sm text-radar-muted';
            statusEl.textContent = 'Processing...';
            statusEl.classList.remove('hidden');

            try {
                const res = await fetch('/api/trade/enter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: document.getElementById('enter-ticker').value.toUpperCase(),
                        price: parseFloat(document.getElementById('enter-price').value) || null,
                        size: document.getElementById('enter-size').value,
                        signal_id: document.getElementById('enter-signal-id').value || null
                    })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.className = 'mt-2 text-sm text-radar-green';
                    statusEl.textContent = `Entered ${data.shares} shares of ${data.ticker} @ ${fmt.money(data.entry_price)}`;
                    document.getElementById('enter-trade-form').reset();
                    setTimeout(() => {
                        hideEnterForm();
                        loadPositions();
                    }, 1500);
                } else {
                    statusEl.className = 'mt-2 text-sm text-radar-red';
                    statusEl.textContent = data.error || 'Failed to enter trade';
                }
            } catch (e) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Network error';
            }
        });

        // Exit trade form
        document.getElementById('exit-trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('exit-trade-status');
            statusEl.className = 'mt-2 text-sm text-radar-muted';
            statusEl.textContent = 'Processing...';
            statusEl.classList.remove('hidden');

            const tradeId = document.getElementById('exit-position').value;
            if (!tradeId) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Please select a position';
                return;
            }

            try {
                const res = await fetch('/api/trade/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trade_id: parseInt(tradeId),
                        price: parseFloat(document.getElementById('exit-price').value) || null,
                        reason: document.getElementById('exit-reason').value
                    })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.className = 'mt-2 text-sm text-radar-green';
                    statusEl.textContent = `Exited ${data.ticker} @ ${fmt.money(data.exit_price)} (${fmt.pct(data.return_pct)})`;
                    document.getElementById('exit-trade-form').reset();
                    loadPositions();
                    loadRecentTrades();
                    loadPerformance();
                } else {
                    statusEl.className = 'mt-2 text-sm text-radar-red';
                    statusEl.textContent = data.error || 'Failed to exit trade';
                }
            } catch (e) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Network error';
            }
        });

        // Refresh all data
        async function refreshAll() {
            await loadHealth();
            await loadStockOfDay();
            await loadPositions();
            await loadWatchlist();
            await loadPerformance();
            await loadRecentTrades();
            await loadRecentInsider();
        }

        // Initial load
        refreshAll();

        // Auto-refresh every 60 seconds
        setInterval(refreshAll, 60000);
    </script>
</body>
</html>
