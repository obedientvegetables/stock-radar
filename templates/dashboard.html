<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Radar Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        radar: {
                            bg: '#0f1419',
                            card: '#1a1f2e',
                            border: '#2f3336',
                            accent: '#00d4aa',
                            muted: '#8899a6',
                            blue: '#1d9bf0',
                            red: '#f4212e',
                            yellow: '#ffd700',
                            green: '#00d4aa',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0f1419; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1a1f2e; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #2f3336; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #3a3f44; }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <!-- Top Bar -->
    <header class="bg-radar-card border-b border-radar-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold">
                        <span class="text-radar-accent">STOCK</span> RADAR
                    </h1>
                    <span id="system-status" class="text-xs px-2 py-1 rounded bg-radar-border text-radar-muted">
                        Loading...
                    </span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <div id="last-update" class="text-radar-muted">
                        <span class="hidden sm:inline">Last update: </span>
                        <span id="last-update-time">--:--</span>
                    </div>
                    <div id="market-status" class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-radar-muted"></span>
                        <span class="text-radar-muted">Market: --</span>
                    </div>
                    <button onclick="refreshAll()" class="px-3 py-1 bg-radar-accent text-radar-bg rounded text-sm font-medium hover:opacity-90 transition">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Section 1: Stock of the Day Hero -->
        <section id="stock-of-day-section" class="bg-radar-card rounded-xl border-2 border-radar-accent p-6">
            <div id="stock-of-day-container">
                <div class="text-radar-muted text-center py-8">Loading...</div>
            </div>
        </section>

        <!-- Section 2: Open Positions -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <span class="text-xl">&#128200;</span> Open Positions
                </h2>
                <div id="portfolio-summary" class="flex items-center gap-4 text-sm">
                    <span class="text-radar-muted">Portfolio: <span id="portfolio-value" class="text-white font-medium">$--</span></span>
                    <span class="text-radar-muted">P&L: <span id="portfolio-pnl" class="font-medium">--</span></span>
                </div>
            </div>
            <div id="positions-container" class="overflow-x-auto scrollbar-thin">
                <div class="text-radar-muted text-center py-8">Loading positions...</div>
            </div>
        </section>

        <!-- Section 3: Other Candidates (filtered signals) -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">&#128269;</span> Other Candidates
            </h2>
            <div id="signals-container" class="space-y-3">
                <div class="text-radar-muted text-center py-8">Loading signals...</div>
            </div>
        </section>

        <!-- Section 4: Recent Insider Buys -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">&#128176;</span> Recent Insider Buys Detected
            </h2>
            <div id="recent-insider-container" class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin">
                <div class="text-radar-muted text-center py-4">Loading...</div>
            </div>
        </section>

        <!-- Section 5: Performance Summary (hidden until 5+ closed trades) -->
        <section id="performance-section" class="bg-radar-card rounded-xl border border-radar-border p-5 hidden">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">&#128202;</span> Performance Summary
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Total Trades</div>
                    <div id="stat-total-trades" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Win Rate</div>
                    <div id="stat-win-rate" class="text-2xl font-bold">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Avg Win</div>
                    <div id="stat-avg-win" class="text-2xl font-bold text-radar-green">--</div>
                </div>
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <div class="text-radar-muted text-xs mb-1">Avg Loss</div>
                    <div id="stat-avg-loss" class="text-2xl font-bold text-radar-red">--</div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Equity Curve vs SPY</h3>
                    <div class="bg-radar-bg rounded-lg p-4 border border-radar-border" style="height: 250px;">
                        <canvas id="equity-chart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-radar-muted mb-3">Performance by Signal Score</h3>
                    <div id="score-breakdown" class="space-y-3">
                        <div class="text-radar-muted text-center py-8">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 6: Quick Actions -->
        <section class="bg-radar-card rounded-xl border border-radar-border p-5">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span class="text-xl">&#9889;</span> Quick Actions
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Enter Trade Form -->
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <h3 class="text-sm font-medium mb-3">Enter New Trade</h3>
                    <form id="enter-trade-form" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Ticker</label>
                                <input type="text" id="enter-ticker" placeholder=""
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent uppercase">
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Price</label>
                                <input type="number" id="enter-price" step="0.01" placeholder=""
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Position Size</label>
                                <select id="enter-size" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                    <option value="FULL">Full Position</option>
                                    <option value="HALF">Half Position</option>
                                    <option value="QUARTER">Quarter Position</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Signal ID (optional)</label>
                                <input type="number" id="enter-signal-id" placeholder=""
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 bg-radar-green text-radar-bg rounded font-medium text-sm hover:opacity-90 transition">
                            Enter Trade
                        </button>
                    </form>
                    <div id="enter-trade-status" class="mt-2 text-sm hidden"></div>
                </div>

                <!-- Exit Trade Form -->
                <div class="bg-radar-bg rounded-lg p-4 border border-radar-border">
                    <h3 class="text-sm font-medium mb-3">Exit Trade</h3>
                    <form id="exit-trade-form" class="space-y-3">
                        <div>
                            <label class="text-xs text-radar-muted">Select Position</label>
                            <select id="exit-position" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                <option value="">-- Select open position --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-radar-muted">Exit Price</label>
                                <input type="number" id="exit-price" step="0.01" placeholder=""
                                    class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                            </div>
                            <div>
                                <label class="text-xs text-radar-muted">Reason</label>
                                <select id="exit-reason" class="w-full mt-1 px-3 py-2 bg-radar-card border border-radar-border rounded text-sm focus:outline-none focus:border-radar-accent">
                                    <option value="TARGET">Target Hit</option>
                                    <option value="STOP">Stop Hit</option>
                                    <option value="TIME">Time Exit</option>
                                    <option value="MANUAL">Manual</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 bg-radar-red text-white rounded font-medium text-sm hover:opacity-90 transition">
                            Exit Trade
                        </button>
                    </form>
                    <div id="exit-trade-status" class="mt-2 text-sm hidden"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="border-t border-radar-border mt-8 py-4">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-radar-muted">
            Stock Radar Dashboard | Paper Trading Only | Not Financial Advice
        </div>
    </footer>

    <script>
        // Formatters
        const fmt = {
            pct: (v, decimals = 2) => v != null ? (v >= 0 ? '+' : '') + v.toFixed(decimals) + '%' : '--',
            money: (v) => v != null ? '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--',
            moneyInt: (v) => v != null ? '$' + Number(v).toLocaleString(undefined, {maximumFractionDigits: 0}) : '--',
            num: (v) => v != null ? Number(v).toLocaleString() : '--',
            date: (v) => v ? new Date(v).toLocaleDateString() : '--',
            time: (v) => v ? new Date(v).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'
        };

        const colorClass = (v) => v > 0 ? 'text-radar-green' : v < 0 ? 'text-radar-red' : 'text-radar-muted';

        let equityChart = null;
        let positionsData = [];
        let stockOfDayTicker = null;  // Track the stock of day to exclude from other candidates

        // Load health status
        async function loadHealth() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();

                document.getElementById('last-update-time').textContent = fmt.time(data.last_collection || new Date());

                const statusEl = document.getElementById('system-status');
                if (data.status === 'healthy') {
                    statusEl.textContent = 'System OK';
                    statusEl.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-radar-green';
                } else {
                    statusEl.textContent = data.status || 'Unknown';
                    statusEl.className = 'text-xs px-2 py-1 rounded bg-yellow-900/50 text-radar-yellow';
                }

                const marketEl = document.getElementById('market-status');
                const dotClass = data.market_open ? 'bg-radar-green' : 'bg-radar-muted';
                const statusText = data.market_open ? 'Open' : 'Closed';
                marketEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full ${dotClass}"></span>
                    <span class="${data.market_open ? 'text-radar-green' : 'text-radar-muted'}">Market: ${statusText}</span>
                `;
            } catch (e) {
                console.error('Error loading health:', e);
            }
        }

        // Load Stock of the Day
        async function loadStockOfDay() {
            try {
                const res = await fetch('/api/stock-of-day');
                const data = await res.json();
                const container = document.getElementById('stock-of-day-container');
                const section = document.getElementById('stock-of-day-section');

                if (data.has_pick) {
                    stockOfDayTicker = data.ticker;
                    section.className = 'bg-radar-card rounded-xl border-2 border-radar-green p-6';

                    container.innerHTML = `
                        <div class="text-center mb-4">
                            <span class="text-3xl">&#127919;</span>
                            <h2 class="text-xl font-bold text-radar-green mt-2">STOCK OF THE DAY</h2>
                        </div>
                        <div class="text-center mb-6">
                            <div class="text-4xl font-bold text-radar-blue mb-1">${data.ticker}</div>
                            <div class="text-radar-muted text-sm">${data.summary || ''}</div>
                        </div>
                        <div class="flex justify-center gap-8 mb-6 text-center">
                            <div>
                                <div class="text-radar-muted text-xs mb-1">Entry</div>
                                <div class="text-xl font-bold">${fmt.money(data.entry)}</div>
                            </div>
                            <div>
                                <div class="text-radar-muted text-xs mb-1">Stop</div>
                                <div class="text-xl font-bold text-radar-red">${fmt.money(data.stop)}</div>
                            </div>
                            <div>
                                <div class="text-radar-muted text-xs mb-1">Target</div>
                                <div class="text-xl font-bold text-radar-green">${fmt.money(data.target)}</div>
                            </div>
                        </div>
                        <div class="text-center mb-6">
                            <span class="px-4 py-2 bg-radar-green/20 text-radar-green rounded-full text-sm font-medium">
                                Confidence: ${data.confidence}
                            </span>
                        </div>
                        <div class="flex justify-center gap-2 text-sm mb-4">
                            <span title="Insider" class="${data.insider_score > 0 ? 'text-radar-green' : 'text-radar-muted'}">&#9679;</span>
                            <span title="Options" class="${data.options_score > 0 ? 'text-radar-green' : 'text-radar-muted'}">&#9679;</span>
                            <span title="Social" class="${data.social_score > 0 ? 'text-radar-green' : 'text-radar-muted'}">&#9679;</span>
                            <span class="text-radar-muted text-xs ml-2">(insider / options / social)</span>
                        </div>
                        <div class="text-center">
                            <button onclick="enterStockOfDay('${data.ticker}', ${data.entry}, ${data.signal_id})"
                                class="px-8 py-3 bg-radar-green text-radar-bg rounded-lg font-bold text-lg hover:opacity-90 transition">
                                Enter Trade
                            </button>
                        </div>
                    `;
                } else {
                    stockOfDayTicker = null;
                    section.className = 'bg-radar-card rounded-xl border-2 border-radar-yellow/50 p-6';

                    // Build rejection reason display
                    let reasonHtml = '';
                    if (data.reason) {
                        reasonHtml = `
                            <div class="mt-4 bg-radar-bg rounded-lg p-4 border border-radar-border max-w-lg mx-auto">
                                <div class="text-sm text-radar-muted mb-1">Reason:</div>
                                <div class="text-sm text-radar-yellow font-medium">${data.reason}</div>
                            </div>
                        `;
                    }

                    // Show top candidates that were considered but didn't qualify
                    let candidatesHtml = '';
                    const topCandidates = data.top_candidates || [];
                    if (topCandidates.length > 0) {
                        candidatesHtml = `
                            <div class="mt-4 max-w-lg mx-auto">
                                <div class="text-xs text-radar-muted mb-2 text-left">Candidates considered:</div>
                                <div class="space-y-1">
                                    ${topCandidates.slice(0, 5).map(c => {
                                        const activeCount = (c.insider_score > 0 ? 1 : 0) +
                                                          (c.options_score > 0 ? 1 : 0) +
                                                          (c.social_score > 0 ? 1 : 0);
                                        const scoreColor = (c.total_score || c.score) >= 35 ? 'text-radar-green' : 'text-radar-muted';
                                        return `
                                            <div class="flex items-center justify-between text-xs bg-radar-bg/50 rounded p-2 border border-radar-border/50">
                                                <span class="text-radar-blue font-medium">${c.ticker}</span>
                                                <span class="${scoreColor}">Score: ${c.total_score || c.score}</span>
                                                <span class="text-radar-muted">${activeCount}/3 signals</span>
                                                <span class="text-radar-muted">I:${c.insider_score || 0} O:${c.options_score || 0} S:${c.social_score || 0}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // Show rejected stocks from quality filter
                    let rejectedHtml = '';
                    const rejectedSamples = data.rejected_samples || [];
                    if (rejectedSamples.length > 0) {
                        rejectedHtml = `
                            <div class="mt-3 max-w-lg mx-auto">
                                <div class="text-xs text-radar-muted mb-1 text-left">Filtered out by quality gate:</div>
                                <div class="text-xs text-radar-muted/70 space-y-0.5">
                                    ${rejectedSamples.slice(0, 5).map(r =>
                                        `<div>${r.ticker}: ${r.reason}</div>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-5xl mb-3">&#128683;</div>
                            <h2 class="text-2xl font-bold text-radar-yellow">NO TRADE TODAY</h2>
                            <div class="text-radar-muted text-sm mt-2">
                                No stock meets the quality bar. Sitting out low-quality days is part of the strategy.
                            </div>
                            ${reasonHtml}
                            ${candidatesHtml}
                            ${rejectedHtml}
                            <div class="text-radar-muted text-xs mt-4 italic">
                                Quality gates: Price &gt; $5 | Market cap &gt; $500M | Avg volume &gt; 500K | Score &gt; ${data.min_score || 35}
                            </div>
                        </div>
                    `;
                }

                // Now load signals (after we know stockOfDayTicker)
                loadSignals();
            } catch (e) {
                console.error('Error loading stock of day:', e);
                document.getElementById('stock-of-day-container').innerHTML =
                    '<div class="text-radar-red text-center py-4">Error loading stock of the day</div>';
            }
        }

        // Helper function to enter stock of day trade
        function enterStockOfDay(ticker, price, signalId) {
            document.getElementById('enter-ticker').value = ticker;
            document.getElementById('enter-price').value = price;
            document.getElementById('enter-signal-id').value = signalId || '';
            // Scroll to quick actions
            document.querySelector('#enter-trade-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Load today's signals (Other Candidates)
        async function loadSignals() {
            try {
                const res = await fetch('/api/signals/today');
                const data = await res.json();
                const container = document.getElementById('signals-container');

                if (!data.signals || data.signals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-radar-muted text-4xl mb-2">&#128064;</div>
                            <div class="text-radar-muted">No signals today</div>
                            <div class="text-xs text-radar-muted mt-1">Check back after market hours</div>
                        </div>
                    `;
                    return;
                }

                // Filter: score > 15, exclude stock of day
                const filtered = data.signals.filter(s =>
                    s.total_score > 15 &&
                    s.ticker !== stockOfDayTicker
                );

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-radar-muted">No other candidates above threshold</div>
                            <div class="text-xs text-radar-muted mt-1">Signals with score &lt;= 15 are hidden (options-only noise)</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(s => {
                    // Signal dots: filled if present, empty if not
                    const insiderDot = s.insider_score > 0 ? '&#9679;' : '&#9675;';
                    const optionsDot = s.options_score > 0 ? '&#9679;' : '&#9675;';
                    const socialDot = s.social_score > 0 ? '&#9679;' : '&#9675;';

                    const insiderColor = s.insider_score > 0 ? 'text-radar-green' : 'text-radar-muted';
                    const optionsColor = s.options_score > 0 ? 'text-radar-green' : 'text-radar-muted';
                    const socialColor = s.social_score > 0 ? 'text-radar-green' : 'text-radar-muted';

                    // Determine why this stock didn't make SOTD
                    let whyNot = '';
                    const activeSignals = (s.insider_score > 0 ? 1 : 0) + (s.options_score > 0 ? 1 : 0) + (s.social_score > 0 ? 1 : 0);
                    if (s.total_score < 35) {
                        whyNot = `Score too low (need 35+)`;
                    } else if (activeSignals < 2) {
                        whyNot = `Only ${activeSignals}/3 signals active (need 2+)`;
                    } else if (s.insider_score < 10 && s.options_score < 10) {
                        whyNot = `No strong signal (insider/options need 10+)`;
                    } else {
                        whyNot = `Not highest scoring candidate`;
                    }

                    return `
                        <div class="border border-radar-border bg-radar-bg/50 rounded-lg p-4">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-radar-blue font-bold text-lg">${s.ticker}</span>
                                    <span class="text-radar-muted text-sm">Score: <span class="text-white font-medium">${s.total_score}</span></span>
                                    <span class="flex gap-1 text-lg" title="Insider / Options / Social">
                                        <span class="${insiderColor}">${insiderDot}</span>
                                        <span class="${optionsColor}">${optionsDot}</span>
                                        <span class="${socialColor}">${socialDot}</span>
                                    </span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-radar-muted">Entry:</span> <span class="font-medium">${fmt.money(s.entry_price)}</span>
                                    <span class="text-radar-muted ml-3">Stop:</span> <span class="text-radar-red">${fmt.money(s.stop_price)}</span>
                                    <span class="text-radar-muted ml-3">Target:</span> <span class="text-radar-green">${fmt.money(s.target_price)}</span>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-radar-muted/70 italic">
                                Not selected: ${whyNot}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading signals:', e);
                document.getElementById('signals-container').innerHTML = '<div class="text-radar-red text-center py-4">Error loading signals</div>';
            }
        }

        // Load open positions
        async function loadPositions() {
            try {
                const res = await fetch('/api/positions');
                const data = await res.json();
                const container = document.getElementById('positions-container');

                positionsData = data.positions || [];

                // Update portfolio summary
                document.getElementById('portfolio-value').textContent = fmt.moneyInt(data.portfolio_value);
                const pnlEl = document.getElementById('portfolio-pnl');
                pnlEl.textContent = fmt.money(data.total_unrealized_pnl) + ` (${fmt.pct(data.total_unrealized_pnl_pct)})`;
                pnlEl.className = `font-medium ${colorClass(data.total_unrealized_pnl)}`;

                // Update exit position dropdown
                const exitSelect = document.getElementById('exit-position');
                exitSelect.innerHTML = '<option value="">-- Select open position --</option>' +
                    positionsData.map(p => `<option value="${p.id}">${p.ticker} - ${p.shares} shares @ ${fmt.money(p.entry_price)}</option>`).join('');

                if (positionsData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-radar-muted">No open positions</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-radar-muted text-xs border-b border-radar-border">
                                <th class="text-left py-2 px-2">Ticker</th>
                                <th class="text-right py-2 px-2">Entry</th>
                                <th class="text-right py-2 px-2">Current</th>
                                <th class="text-right py-2 px-2">P&L</th>
                                <th class="text-right py-2 px-2">Days</th>
                                <th class="text-left py-2 px-2 hidden sm:table-cell">To Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${positionsData.map(p => {
                                const pnlPct = p.unrealized_pnl_pct || 0;
                                const targetProgress = p.target_progress || 0;
                                const progressColor = pnlPct >= 0 ? 'bg-radar-green' : 'bg-radar-red';
                                return `
                                    <tr class="border-b border-radar-border/50 hover:bg-radar-border/20">
                                        <td class="py-3 px-2">
                                            <span class="text-radar-blue font-bold">${p.ticker}</span>
                                            <span class="text-radar-muted text-xs ml-1">${p.shares} sh</span>
                                        </td>
                                        <td class="text-right py-3 px-2">${fmt.money(p.entry_price)}</td>
                                        <td class="text-right py-3 px-2 font-medium">${fmt.money(p.current_price)}</td>
                                        <td class="text-right py-3 px-2">
                                            <span class="${colorClass(p.unrealized_pnl)}">${fmt.money(p.unrealized_pnl)}</span>
                                            <span class="${colorClass(pnlPct)} text-xs ml-1">${fmt.pct(pnlPct)}</span>
                                        </td>
                                        <td class="text-right py-3 px-2 text-radar-muted">${p.days_held}</td>
                                        <td class="py-3 px-2 hidden sm:table-cell">
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 h-2 bg-radar-border rounded overflow-hidden">
                                                    <div class="h-full ${progressColor}" style="width: ${Math.min(100, Math.max(0, targetProgress))}%"></div>
                                                </div>
                                                <span class="text-xs text-radar-muted w-10">${targetProgress.toFixed(0)}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                console.error('Error loading positions:', e);
                document.getElementById('positions-container').innerHTML = '<div class="text-radar-red text-center py-4">Error loading positions</div>';
            }
        }

        // Load performance summary (only show if 5+ closed trades)
        async function loadPerformance() {
            try {
                const res = await fetch('/api/performance');
                const data = await res.json();

                const section = document.getElementById('performance-section');
                const totalTrades = data.total_trades || 0;

                // Only show if 5+ closed trades
                if (totalTrades < 5) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');

                document.getElementById('stat-total-trades').textContent = totalTrades;
                document.getElementById('stat-win-rate').textContent = data.win_rate != null ? data.win_rate.toFixed(1) + '%' : '--';
                document.getElementById('stat-avg-win').textContent = data.avg_win != null ? fmt.pct(data.avg_win) : '--';
                document.getElementById('stat-avg-loss').textContent = data.avg_loss != null ? fmt.pct(data.avg_loss) : '--';

                // Score breakdown
                const scoreContainer = document.getElementById('score-breakdown');
                if (data.by_score_tier && data.by_score_tier.length > 0) {
                    scoreContainer.innerHTML = data.by_score_tier.map(tier => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-radar-muted">Score ${tier.tier}</span>
                            <div class="flex items-center gap-4">
                                <span class="text-xs text-radar-muted">${tier.count} trades</span>
                                <span class="${colorClass(tier.avg_return)}">${fmt.pct(tier.avg_return)}</span>
                                <span class="text-xs text-radar-muted">${tier.win_rate?.toFixed(0) || '--'}% win</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    scoreContainer.innerHTML = '<div class="text-radar-muted text-center py-4 text-sm">No closed trades yet</div>';
                }

                // Equity chart
                renderEquityChart(data.equity_curve || [], data.spy_curve || []);
            } catch (e) {
                console.error('Error loading performance:', e);
            }
        }

        // Render equity chart
        function renderEquityChart(equityCurve, spyCurve) {
            const ctx = document.getElementById('equity-chart').getContext('2d');

            if (equityChart) {
                equityChart.destroy();
            }

            const labels = equityCurve.map(p => p.date);
            const equityData = equityCurve.map(p => p.value);
            const spyData = spyCurve.map(p => p.value);

            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Portfolio',
                            data: equityData,
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                        },
                        {
                            label: 'SPY',
                            data: spyData,
                            borderColor: '#8899a6',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#8899a6', boxWidth: 12 }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { color: '#2f3336' },
                            ticks: { color: '#8899a6', maxTicksLimit: 6 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#2f3336' },
                            ticks: {
                                color: '#8899a6',
                                callback: (v) => v.toFixed(0) + '%'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Load recent insider activity
        async function loadRecentInsider() {
            try {
                const res = await fetch('/api/insider/recent');
                const data = await res.json();
                const container = document.getElementById('recent-insider-container');

                if (!data.insider_buys || data.insider_buys.length === 0) {
                    container.innerHTML = '<div class="text-radar-muted text-center py-4 text-sm">No recent insider buys</div>';
                    return;
                }

                container.innerHTML = data.insider_buys.map(i => `
                    <div class="flex items-center justify-between p-2 bg-radar-bg rounded border border-radar-border/50">
                        <div>
                            <span class="text-radar-blue font-medium">${i.ticker}</span>
                            <span class="text-radar-muted text-xs ml-2">${i.insider_name || 'Insider'}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-radar-green font-medium">${fmt.moneyInt(i.total_value)}</span>
                            <span class="text-radar-muted text-xs ml-2">${fmt.date(i.trade_date)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading recent insider:', e);
            }
        }

        // Enter trade form
        document.getElementById('enter-trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('enter-trade-status');
            statusEl.className = 'mt-2 text-sm text-radar-muted';
            statusEl.textContent = 'Processing...';
            statusEl.classList.remove('hidden');

            try {
                const res = await fetch('/api/trade/enter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticker: document.getElementById('enter-ticker').value.toUpperCase(),
                        price: parseFloat(document.getElementById('enter-price').value) || null,
                        size: document.getElementById('enter-size').value,
                        signal_id: document.getElementById('enter-signal-id').value || null
                    })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.className = 'mt-2 text-sm text-radar-green';
                    statusEl.textContent = `Entered ${data.shares} shares of ${data.ticker} @ ${fmt.money(data.entry_price)}`;
                    document.getElementById('enter-trade-form').reset();
                    loadPositions();
                } else {
                    statusEl.className = 'mt-2 text-sm text-radar-red';
                    statusEl.textContent = data.error || 'Failed to enter trade';
                }
            } catch (e) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Network error';
            }
        });

        // Exit trade form
        document.getElementById('exit-trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById('exit-trade-status');
            statusEl.className = 'mt-2 text-sm text-radar-muted';
            statusEl.textContent = 'Processing...';
            statusEl.classList.remove('hidden');

            const tradeId = document.getElementById('exit-position').value;
            if (!tradeId) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Please select a position';
                return;
            }

            try {
                const res = await fetch('/api/trade/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trade_id: parseInt(tradeId),
                        price: parseFloat(document.getElementById('exit-price').value) || null,
                        reason: document.getElementById('exit-reason').value
                    })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.className = 'mt-2 text-sm text-radar-green';
                    statusEl.textContent = `Exited ${data.ticker} @ ${fmt.money(data.exit_price)} (${fmt.pct(data.return_pct)})`;
                    document.getElementById('exit-trade-form').reset();
                    loadPositions();
                    loadPerformance();
                } else {
                    statusEl.className = 'mt-2 text-sm text-radar-red';
                    statusEl.textContent = data.error || 'Failed to exit trade';
                }
            } catch (e) {
                statusEl.className = 'mt-2 text-sm text-radar-red';
                statusEl.textContent = 'Network error';
            }
        });

        // Refresh all data
        function refreshAll() {
            loadHealth();
            loadStockOfDay();  // This also calls loadSignals after it completes
            loadPositions();
            loadPerformance();
            loadRecentInsider();
        }

        // Initial load
        refreshAll();

        // Auto-refresh every 60 seconds
        setInterval(refreshAll, 60000);
    </script>
</body>
</html>
